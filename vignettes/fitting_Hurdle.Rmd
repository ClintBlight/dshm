---
title: "Fitting Hurdle Models with the dshm R-Package"
author: "Filippo Franchini"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi=300
)

load("/Users/User/Desktop/dshm/data/obsdata.rda")
load("/Users/User/Desktop/dshm/data/mod_hr.rda")
load("/Users/User/Desktop/dshm/data/H_m.rda")
load("/Users/User/Desktop/dshm/data/grid_final.rda")
```

## Summary

In this tutorial you will learn how to use the `dshm` R-package to:

- Fit Hurdle models.
- Run diagnostics tool on fitted models.
- Bootstrap confidence intervals.
- Plot model predictions.
- Investigate spatial correlation.

## Fit Hurdle Models

The dataset `obsdata` is an observation dataset containing information for dolphin sightings. Each row represents a sighting with information about `size` (i.e. number of dolphins); `distance` (i.e. the perpendicular distance in km from the transect line); `Latitude` and `Longitude` in degrees (i.e. coordinates); and finally `Sample.Label`, `Transect.Label` and `Region.Label` (i.e. the segment, transect and stratum where the sighting is located, respectively).

```{r, echo=FALSE, results='asis',fig.height=6,fig.width=6}
knitr::kable(head(obsdata, 6))
```

We can use the `obsdata` dataset to fit a detection function as follows:

    mod_hr <- Distance::ds(data = obsdata, transect = "line",
              key = "hr", adjustment = NULL, truncation = max(obsdata$distance))

The code you just used creates a `ds` object by fitting a half-rate detection function to the distances in `obsdata`. You can then plot the fitted detection function:

```{r, echo=FALSE, out.width = "300px",fig.height=6,fig.width=6}
plot(mod_hr,showpoints=FALSE)
```

The `mod_hr` can the be used to fit the Hurdle model using the function `dshm_fit` in two steps. First we need to specify the variants for each of the two Hurdle submodels:

    variants.pa <- c("s(DC,bs='cs')",
                  "s(DR,bs='cs')",
                  "s(depth,bs='cs')")

    variants.ab <- c("s(DC,bs='cs')",
                  "s(DR,bs='cs')",
                  "s(depth,bs='cs')")
                  
The two objects `variants.pa` and `variants.ab` are the variants for the presence-absence (`pa`) and abundance-given-presence (`ab`) submodels, respectively. You can specify any time of structure as long as it respects the `mgcv` R-package syntax.

Now we can fit the Hurdle model using by typing:

    H_m<-dshm_fit(det.fn=mod_hr,
             obsdata=obsdata,
             segdata=cor_seg_final@data,
             grid=grid_final@data,
             effects.pa = effects.pa,
             effects.ab = effects.ab)
             
You can run the model diagnostics as follows:

    dshm_diagnostics(model = H_m,
                 plot=TRUE,
                 plot.n = 2)
                 
This produces two plots:

- EDF vs. CDF
- Fitted vs. observed values

It also calculates KS statistics.
                 
You can then plot the Hurdle model predictions on the prediction grid using the function `dshm_plot`:

    dshm_plot(prediction = H_m$grid_data$H,
          grid = grid_final,
          species = "Dolphin",
          map_type = "Hurdle",
          cex = 4,
          scale_col = c("lightblue","blue","yellow","orange","red","red"),
          scale_val = c(0,1,1.5,2,3.5,4))
          
The function `dshm_plot` allows to quickly explore the Hurdle model prodictions. You can quickly change the color scale and intervals for each color using the arguments `scale_col` and `scale_val`. After exploring different colours and intervals you can decide to save the grid as a raster image by setting the `saveRaster = TRUE`. This will save the raster as a .tif image with the name `map_type species.tif` (in this case `Hurdle Dolphin.tif`) in your working directory.


    plot(raster::raster("Hurdle Dolphin.tif"),col=colorRampPalette(c("lightblue","blue","yellow","red"))(20))
    
    
    plot(La$models$pa[[H.m$info$ID.pa[1]]],select=1,shade=TRUE)
    
    
    boot<-dshm_boot(det.fn.par=list(transect="line",key="hr",
                                adjustment=NULL,formula=~1,
                                truncation = max(obsdata$distance)),
                   effects.pa = effects.pa,
                   effects.ab = effects.ab,
                   distdata = obsdata,
                   obsdata = obsdata,
                   segdata = cor_seg_final@data,
                   grid = grid_final@data, 
                   model_fit = H.m,
                   nsim = 10,
                   parallel = TRUE,
                   ncores = 6)
    
    ci <- function(x,type){
            if (type == "lwr") {
              ci<-quantile(x,probs = 0.025,na.rm = TRUE)
            } else {
              ci<-quantile(x,probs = 0.975,na.rm = TRUE)
            }
          }
    
    
    lwr.int<-apply(boot$sim_grids,1,ci,type="lwr")
    upr.int<-apply(boot$sim_grids,1,ci,type="upr")
